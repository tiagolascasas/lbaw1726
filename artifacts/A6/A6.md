# A6: Indexes, triggers, user functions and population

This artefact was developed with the purpose of determining what the main queries and updates would be done to the database and, from that information, estimate the impact those operations would have on the system. After that analysis, indexes were created in order to improve their performance. Alongside that study, the team also created a set of triggers whose purpose is to enforce certain multi-table constraints and to do certain updates that couldn't otherwise be done using standard operations. Finally, it was also created a set of default data whose purpose is to give an initial population to the database, which is useful for testing purposes.

## 1. Database Workload

### 1.1. Tuple Estimation


| Relation reference | Relation Name | Order of magnitude        | Estimated growth |
| ------------------ | ------------- | ------------------------- | ---------------- |
| R01                | Administrator        | one                   | no growth |
| R02                | Country              | dozens                | no growth |
| R03                | Member               | tens of thousands     | dozens per day |
| R04                | RequestedTermination | dozens                | units per month |
| R05                | Auction              | tens of thousands     | dozens per day |
| R06                | Category             | dozens                | no growth |
| R07                | Publisher            | hundreds              | dozens per week |
| R08                | Language             | dozens                | no growth |
| R09                | CategoryAuction      | tens of thousands     | dozens per day |
| R10                | Wishlist             | thousands             | dozens per day |
| R11                | Bid                  | hundreds of thousands | hundreds per day |
| R12                | AuctionModification  | hundreds              | dozens per month |
| R13                | Notification         | hundreds of thousands | hundreds per day |
| R14                | NotificationAuction  | hundreds of thousands | hundreds per day |
| R15                | Image                | hundreds of thousands | hundreds per day |
| R16                | Message              | thousands             | dozens per day |
| R17                | Comment              | thousands             | dozens per day |


### 1.2. Frequent Queries

<table>
  <tr>
    <th><strong>Query reference</strong></th>
    <th>SELECT01</th>
  </tr>
  <tr>
    <td><strong>Query description</strong></td>
    <td>User profile</td>
  </tr>
  <tr>
    <td><strong>Query frequency</strong></td>
    <td>hundreds per day </td>
  </tr>
  <tr>
    <td colspan="2">
    <code style="display:block;white-space: pre-wrap">
SELECT *
FROM member, image, comment
WHERE member.idImage = image.id AND member.id = $userID;

SELECT datePosted, liked, text, idParent, idSender, idReceiver, username
FROM comment, member
WHERE comment.idParent = $profileID AND is_removed = false AND comment.idSender = member.id;
    </code>
	</td>
  </tr>
</table>


<table>
  <tr>
    <th><strong>Query reference</strong></th>
    <th>SELECT02</th>
  </tr>
  <tr>
    <td><strong>Query description</strong></td>
    <td>Auction page</td>
  </tr>
  <tr>
    <td><strong>Query frequency</strong></td>
    <td>thousands per day </td>
  </tr>
  <tr>
    <td colspan="2">
    <code style="display:block;white-space: pre-wrap">
SELECT auction.&#42;, member.username
FROM auction, member
WHERE auction.id = $auctionID AND idSeller = member.id;

SELECT source
FROM image
WHERE idAuction = $auctionID;
    </code>
	</td>
  </tr>
</table>


<table>
  <tr>
    <th><strong>Query reference</strong></th>
    <th>SELECT03</th>
  </tr>
  <tr>
    <td><strong>Query description</strong></td>
    <td>Current maximum value of auction</td>
  </tr>
  <tr>
    <td><strong>Query frequency</strong></td>
    <td>tens of thousands per day </td>
  </tr>
  <tr>
    <td colspan="2">
		<code style="display:block;white-space: pre-wrap">
SELECT max(bidValue)
FROM bid
WHERE idAuction = $auctionID;
		</code>
	</td>
  </tr>
</table>


<table>
  <tr>
    <th><strong>Query reference</strong></th>
    <th>SELECT04</th>
  </tr>
  <tr>
    <td><strong>Query description</strong></td>
    <td>Search auction</td>
  </tr>
  <tr>
    <td><strong>Query frequency</strong></td>
    <td>hundreds per day </td>
  </tr>
  <tr>
    <td colspan="2">
		<code style="display:block;white-space: pre-wrap">
--Search by category
SELECT auction.&#42;, image.source
FROM auction, categoryAuction, category, image
WHERE categoryAuction.idAuction = auction.idAuction AND categoryAuction.idCategory = category.id AND category.categoryName = $catName AND image.idAuction = auction.idAuction;

--Search by language
SELECT auction.&#42;, image.source
FROM auction, language, image
WHERE auction.idLanguage = language.id AND language.language = $langName AND image.idAuction = auction.idAuction;

--Search by fields
SELECT auction.&#42;, image.source
FROM auction, image
WHERE isbn = $isbn OR author = $author OR title = $title;  
		</code>
	</td>
  </tr>
</table>


<table>
  <tr>
    <th><strong>Query reference</strong></th>
    <th>SELECT05
	</th>
  </tr>
  <tr>
    <td><strong>Query description</strong></td>
    <td>Notifications</td>
  </tr>
  <tr>
    <td><strong>Query frequency</strong></td>
    <td>tens of thousands per day </td>
  </tr>
  <tr>
    <td colspan="2">
		<code style="display:block;white-space: pre-wrap">
SELECT notifications.*
FROM notifications
WHERE idMember = $userID AND is_seen = false;
		</code>
	</td>
  </tr>
</table>

<table>
  <tr>
    <th><strong>Query reference</strong></th>
    <th>SELECT06
	</th>
  </tr>
  <tr>
    <td><strong>Query description</strong></td>
    <td>User's complete wishlist</td>
  </tr>
  <tr>
    <td><strong>Query frequency</strong></td>
    <td>thousands per day </td>
  </tr>
  <tr>
    <td colspan="2">
		<code style="display:block;white-space: pre-wrap">
SELECT auction.&#42;
FROM auction, wishlist
WHERE wishlist.idBuyer = $userID AND wishlist.idAuction = auction.id;
		</code>
	</td>
  </tr>
</table>


<table>
  <tr>
    <th><strong>Query reference</strong></th>
    <th>SELECT07
	</th>
  </tr>
  <tr>
    <td><strong>Query description</strong></td>
    <td>Auctions the user participated</td>
  </tr>
  <tr>
    <td><strong>Query frequency</strong></td>
    <td>thousands per day </td>
  </tr>
  <tr>
    <td colspan="2">
		<code style="display:block;white-space: pre-wrap">
SELECT auction.&#42;
FROM auction, bid
WHERE bid.idAuction = auction.id AND bid.idBuyer = $userID;
		</code>
	</td>
  </tr>
</table>


<table>
  <tr>
    <th><strong>Query reference</strong></th>
    <th>SELECT08
	</th>
  </tr>
  <tr>
    <td><strong>Query description</strong></td>
    <td>Auctions the user created</td>
  </tr>
  <tr>
    <td><strong>Query frequency</strong></td>
    <td>thousands per day </td>
  </tr>
  <tr>
    <td colspan="2">
		<code style="display:block;white-space: pre-wrap">
SELECT auction.&#42;
FROM auction
WHERE auction.idSeller = $userID;
		</code>
	</td>
  </tr>
</table>

### 1.3. Frequent Updates

<table>
  <tr>
    <th><strong>Query reference</strong></th>
    <th>UPDATE01
	</th>
  </tr>
  <tr>
    <td><strong>Query description</strong></td>
    <td>Bid on an auction</td>
  </tr>
  <tr>
    <td><strong>Query frequency</strong></td>
    <td>thousands per day </td>
  </tr>
  <tr>
    <td colspan="2">
		<code style="display:block;white-space: pre-wrap">
UPDATE bid
SET bidValue = $newValue, bidDate = now()
WHERE idBuyer = $userID AND idAuction = $auctionID;
		</code>
	</td>
  </tr>
</table>


<table>
  <tr>
    <th><strong>Query reference</strong></th>
    <th>UPDATE02
	</th>
  </tr>
  <tr>
    <td><strong>Query description</strong></td>
    <td>Mark a notification as read</td>
  </tr>
  <tr>
    <td><strong>Query frequency</strong></td>
    <td>hundreds per day </td>
  </tr>
  <tr>
    <td colspan="2">
		<code style="display:block;white-space: pre-wrap">
UPDATE notification
SET is_seen = TRUE, dateSeen = now()
WHERE idMember = $userID;
		</code>
	</td>
  </tr>
</table>


<table>
  <tr>
    <th><strong>Query reference</strong></th>
    <th>UPDATE03
	</th>
  </tr>
  <tr>
    <td><strong>Query description</strong></td>
    <td>Set comment as removed</td>
  </tr>
  <tr>
    <td><strong>Query frequency</strong></td>
    <td>dozens per day</td>
  </tr>
  <tr>
    <td colspan="2">
		<code style="display:block;white-space: pre-wrap">
UPDATE comment
SET is_removed = TRUE
WHERE id = $commentID;
		</code>
	</td>
  </tr>
</table>

<table>
  <tr>
    <th><strong>Query reference</strong></th>
    <th>UPDATE03
	</th>
  </tr>
  <tr>
    <td><strong>Query description</strong></td>
    <td>Update an auction</td>
  </tr>
  <tr>
    <td><strong>Query frequency</strong></td>
    <td>dozens per day</td>
  </tr>
  <tr>
    <td colspan="2">
		<code style="display:block;white-space: pre-wrap">
UPDATE auction
SET description = $newDescription
WHERE id = $auctionID;

UPDATE image
SET idAuction = $auctionID, idAuctionModification = NULL
WHERE idAuctionModification = $modificationID;
		</code>
	</td>
  </tr>
</table>


<table>
  <tr>
    <th><strong>Query reference</strong></th>
    <th>INSERT01
	</th>
  </tr>
  <tr>
    <td><strong>Query description</strong></td>
    <td>Create a new user</td>
  </tr>
  <tr>
    <td><strong>Query frequency</strong></td>
    <td>dozens per day</td>
  </tr>
  <tr>
    <td colspan="2">
		<code style="display:block;white-space: pre-wrap">
INSERT INTO member (address, age, email, name, password, phone, postalCode, username, idCountry)
VALUES ($address, $age, $email, $name, $password, $phone, $postalCode, $username, $idCountry);
		</code>
	</td>
  </tr>
</table>


<table>
  <tr>
    <th><strong>Query reference</strong></th>
    <th>INSERT02
	</th>
  </tr>
  <tr>
    <td><strong>Query description</strong></td>
    <td>Create a new auction</td>
  </tr>
  <tr>
    <td><strong>Query frequency</strong></td>
    <td>dozens per day</td>
  </tr>
  <tr>
    <td colspan="2">
		<code style="display:block;white-space: pre-wrap">
INSERT INTO auction (author, description, duration, ISBN, title, idPublisher, idLanguage, idSeller)
VALUES ($author, $description, $duration, $ISBN, $title, $idPublisher, $idLanguage, $userID);
		</code>
	</td>
  </tr>
</table>


<table>
  <tr>
    <th><strong>Query reference</strong></th>
    <th>INSERT03
	</th>
  </tr>
  <tr>
    <td><strong>Query description</strong></td>
    <td>Create a new comment</td>
  </tr>
  <tr>
    <td><strong>Query frequency</strong></td>
    <td>dozens per day</td>
  </tr>
  <tr>
    <td colspan="2">
		<code style="display:block;white-space: pre-wrap">
INSERT INTO comment (liked, comment_text, idParent, idSender, idReceiver)
VALUES ($liked, $comment_text, $idParent, $userID, $profileID);
		</code>
	</td>
  </tr>
</table>


<table>
  <tr>
    <th><strong>Query reference</strong></th>
    <th>INSERT04
	</th>
  </tr>
  <tr>
    <td><strong>Query description</strong></td>
    <td>Create a new notification</td>
  </tr>
  <tr>
    <td><strong>Query frequency</strong></td>
    <td>hundreds per day</td>
  </tr>
  <tr>
    <td colspan="2">
		<code style="display:block;white-space: pre-wrap">
INSERT INTO notification (information, idMember)
VALUES ($information, $idMember);

INSERT INTO notification_auction (idAuction, idNotification)
VALUES ($idAuction, $idNotification);
		</code>
	</td>
  </tr>
</table>


<table>
  <tr>
    <th><strong>Query reference</strong></th>
    <th>INSERT05
	</th>
  </tr>
  <tr>
    <td><strong>Query description</strong></td>
    <td>Wishlist an auction</td>
  </tr>
  <tr>
    <td><strong>Query frequency</strong></td>
    <td>dozens per day</td>
  </tr>
  <tr>
    <td colspan="2">
		<code style="display:block;white-space: pre-wrap">
INSERT INTO wishlist (idBuyer, idAuction)
VALUES ($userID, $idAuction);
		</code>
	</td>
  </tr>
</table>

<table>
  <tr>
    <th><strong>Query reference</strong></th>
    <th>INSERT06
	</th>
  </tr>
  <tr>
    <td><strong>Query description</strong></td>
    <td>Bid on an auction for the first time</td>
  </tr>
  <tr>
    <td><strong>Query frequency</strong></td>
    <td>dozens per day</td>
  </tr>
  <tr>
    <td colspan="2">
		<code style="display:block;white-space: pre-wrap">
INSERT INTO bid (idBuyer, idAuction, bidValue)
VALUES ($userID, $idAuction, $bidValue);
		</code>
	</td>
  </tr>
</table>


<table>
  <tr>
    <th><strong>Query reference</strong></th>
    <th>INSERT07
	</th>
  </tr>
  <tr>
    <td><strong>Query description</strong></td>
    <td>Create a message for another user</td>
  </tr>
  <tr>
    <td><strong>Query frequency</strong></td>
    <td>dozens per day</td>
  </tr>
  <tr>
    <td colspan="2">
		<code style="display:block;white-space: pre-wrap">
INSERT INTO message (message_text, idSender, idReceiver)
VALUES ($text, $userID, $receiverID);
		</code>
	</td>
  </tr>
</table>


<table>
  <tr>
    <th><strong>Query reference</strong></th>
    <th>INSERT08
	</th>
  </tr>
  <tr>
    <td><strong>Query description</strong></td>
    <td>Upload an image</td>
  </tr>
  <tr>
    <td><strong>Query frequency</strong></td>
    <td>hundreds per day</td>
  </tr>
  <tr>
    <td colspan="2">
		<code style="display:block;white-space: pre-wrap">
--for users
INSERT INTO image (source)
VALUES ($source);

--for auctions
INSERT INTO image (source, idAuction)
VALUES ($source, $idAuction);

--for auction modifications
INSERT INTO image (source, idAuctionModification)
VALUES ($source, $idAuctionModification);
		</code>
	</td>
  </tr>
</table>


<table>
  <tr>
    <th><strong>Query reference</strong></th>
    <th>DELETE01
	</th>
  </tr>
  <tr>
    <td><strong>Query description</strong></td>
    <td>Delete an auction modification</td>
  </tr>
  <tr>
    <td><strong>Query frequency</strong></td>
    <td>dozens per month</td>
  </tr>
  <tr>
    <td colspan="2">
		<code style="display:block;white-space: pre-wrap">
DELETE FROM auction_modification
WHERE idApprovedAuction = $idAuction;
		</code>
	</td>
  </tr>
</table>


<table>
  <tr>
    <th><strong>Query reference</strong></th>
    <th>DELETE02
	</th>
  </tr>
  <tr>
    <td><strong>Query description</strong></td>
    <td>Delete a feedback comment</td>
  </tr>
  <tr>
    <td><strong>Query frequency</strong></td>
    <td>dozens per month</td>
  </tr>
  <tr>
    <td colspan="2">
		<code style="display:block;white-space: pre-wrap">
DELETE FROM comment
WHERE id = $idComment;
		</code>
	</td>
  </tr>
</table>

## 2. Proposed Indices

### 2.1. Performance Indices

> Indices proposed to improve performance of the identified queries.

| Index reference | IDX01                                  |
| Related queries | SELECT01, ...                          |
| Index relation  | Relation where the index is applied    |
| Index attribute | Attribute where the index is applied   |
| Index type      | B-tree, Hash, GiST or GIN              |
| Cardinality     | Attribute cardinality: low/medium/high |
| Clustering      | Clustering of the index                |
| --------------- | -------------------------------------- |
| Justification   | Justification for the proposed index   |
| --------------- | -------------------------------------- |
| SQL code                                                 |


### 2.2. Full-text Search Indices

> The system being developed must provide full-text search features supported by PostgreSQL. Thus, it is necessary to specify the fields where full-text search will be available and the associated setup, namely all necessary configurations, indexes definitions and other relevant details.

| Index reference | IDX01                                  |
| Related queries | SELECT01, ...                          |
| Index relation  | Relation where the index is applied    |
| Index attribute | Attribute where the index is applied   |
| Index type      | B-tree, Hash, GiST or GIN              |
| Clustering      | Clustering of the index                |
| --------------- | -------------------------------------- |
| Justification   | Justification for the proposed index   |
| --------------- | -------------------------------------- |
| SQL code                                                 |


## 3. Triggers

> User-defined functions and trigger procedures that add control structures to the SQL language or perform complex computations, are identified and described to be trusted by the database server. Every kind of function (SQL functions, Stored procedures, Trigger procedures) can take base types, composite types, or combinations of these as arguments (parameters). In addition, every kind of function can return a base type or a composite type. Functions can also be defined to return sets of base or composite values.

| Trigger reference   | TRIGGER01                                                               |
| Trigger description | Trigger description, including reference to the business rules involved |
| ------------------- | ----------------------------------------------------------------------- |
| SQL code                                                                                      |


## 4. Complete SQL Code

> The database script must also include the SQL to populate a database with test data with an amount of tuples suitable for testing and with plausible values for the fields of the database.
> This code should also be included in the group's github repository as an SQL script, and a link include here.


## Revision history

Changes made to the first submission:
1. Item 1
1. Item 2

***

GROUP17xx, xx/xx/2018

> Group member 1 name, email
> Group member 2 name, email
